{"version":3,"sources":["../src/index.ts","../src/provider.tsx"],"sourcesContent":["export * from './types';\nexport * from './provider';\n","'use client';\n\nimport React, {\n  FC,\n  ReactNode,\n  createContext,\n  useContext,\n  useEffect,\n  useMemo,\n} from 'react';\nimport { CookieAttributes, Cookies } from './types';\nimport jsCookies from 'js-cookie';\nimport { ServerInsertedHTMLContext } from 'next/navigation';\nimport { ServerInsertedHTMLHook } from 'next/dist/shared/lib/server-inserted-html';\n\n// Context\n\nconst Ctx = createContext<Cookies | null>(null);\n\nexport const useCookies = (): Cookies => {\n  const cookies = useContext(Ctx);\n\n  if (typeof window !== 'undefined') {\n    return jsCookies;\n  }\n\n  if (!cookies) {\n    throw new Error('Missing <CookiesProvider>');\n  }\n\n  return cookies;\n};\n\n// SSR Provider\n\ninterface CookieRecord {\n  name: string;\n  value: string;\n}\n\ntype CookieCommand = {\n  [key in keyof Cookies]: [key, ...Parameters<Cookies[key]>];\n}['set' | 'remove'];\n\ntype SerializedValue<T> = {\n  [K in keyof T]: Date extends T[K]\n    ? string\n    : object extends T[K]\n    ? SerializedValue<T[K]>\n    : T[K];\n};\n\ndeclare global {\n  interface Window {\n    __cookies_commands: SerializedValue<CookieCommand>[];\n  }\n}\n\nexport const CookiesProvider: FC<{\n  value: CookieRecord[];\n  children: ReactNode;\n}> = ({ value, children }) => {\n  const insertedHTML = useContext<ServerInsertedHTMLHook | null>(\n    ServerInsertedHTMLContext as never,\n  );\n\n  const cookies = useMemo((): Cookies => {\n    const map: Partial<Record<string, string>> = Object.fromEntries(\n      value.map((c) => [c.name, c.value]),\n    );\n\n    return {\n      get: (name?: string) => (name == null ? { ...map } : map[name]) as never,\n      set: (...args) => {\n        insertedHTML?.(() => getCookieCommandHtml('set', ...args));\n        return map[args[0]];\n      },\n      remove: (...args) => {\n        insertedHTML?.(() => getCookieCommandHtml('remove', ...args));\n      },\n    };\n  }, [value, insertedHTML]);\n\n  useEffect(() => {\n    const commands = window.__cookies_commands || [];\n    if (!commands.length) return;\n\n    for (const command of commands) {\n      runCookieCommand(command);\n    }\n  }, []);\n\n  return <Ctx.Provider value={cookies}>{children}</Ctx.Provider>;\n};\n\nconst getCookieCommandHtml = (...command: CookieCommand) => (\n  <script\n    dangerouslySetInnerHTML={{\n      __html: `window.__cookies_commands = window.__cookies_commands || [];window.__cookies_commands.push(${JSON.stringify(\n        command,\n      ).replaceAll('</', '<\\\\/')});`,\n    }}\n  />\n);\n\nconst runCookieCommand = (command: SerializedValue<CookieCommand>) => {\n  if (typeof window === 'undefined') return;\n\n  switch (command[0]) {\n    case 'set': {\n      jsCookies.set(\n        command[1],\n        command[2],\n        command[3] && deserializeCookieAttributes(command[3]),\n      );\n      break;\n    }\n\n    case 'remove': {\n      jsCookies.remove(\n        command[1],\n        command[2] && deserializeCookieAttributes(command[2]),\n      );\n      break;\n    }\n  }\n};\n\nconst deserializeCookieAttributes = (\n  attributes: SerializedValue<CookieAttributes>,\n): CookieAttributes => ({\n  ...attributes,\n  expires:\n    typeof attributes.expires === 'string'\n      ? new Date(attributes.expires)\n      : attributes.expires,\n});\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;ACEA,mBAOO;AAEP,uBAAsB;AACtB,wBAA0C;AAK1C,IAAM,UAAM,4BAA8B,IAAI;AAEvC,IAAM,aAAa,MAAe;AACvC,QAAM,cAAU,yBAAW,GAAG;AAE9B,MAAI,OAAO,WAAW,aAAa;AACjC,WAAO,iBAAAA;AAAA,EACT;AAEA,MAAI,CAAC,SAAS;AACZ,UAAM,IAAI,MAAM,2BAA2B;AAAA,EAC7C;AAEA,SAAO;AACT;AA2BO,IAAM,kBAGR,CAAC,EAAE,OAAO,SAAS,MAAM;AAC5B,QAAM,mBAAe;AAAA,IACnB;AAAA,EACF;AAEA,QAAM,cAAU,sBAAQ,MAAe;AACrC,UAAM,MAAuC,OAAO;AAAA,MAClD,MAAM,IAAI,CAAC,MAAM,CAAC,EAAE,MAAM,EAAE,KAAK,CAAC;AAAA,IACpC;AAEA,WAAO;AAAA,MACL,KAAK,CAAC,SAAmB,QAAQ,OAAO,EAAE,GAAG,IAAI,IAAI,IAAI,IAAI;AAAA,MAC7D,KAAK,IAAI,SAAS;AAChB,uBAAe,MAAM,qBAAqB,OAAO,GAAG,IAAI,CAAC;AACzD,eAAO,IAAI,KAAK,CAAC,CAAC;AAAA,MACpB;AAAA,MACA,QAAQ,IAAI,SAAS;AACnB,uBAAe,MAAM,qBAAqB,UAAU,GAAG,IAAI,CAAC;AAAA,MAC9D;AAAA,IACF;AAAA,EACF,GAAG,CAAC,OAAO,YAAY,CAAC;AAExB,8BAAU,MAAM;AACd,UAAM,WAAW,OAAO,sBAAsB,CAAC;AAC/C,QAAI,CAAC,SAAS;AAAQ;AAEtB,eAAW,WAAW,UAAU;AAC9B,uBAAiB,OAAO;AAAA,IAC1B;AAAA,EACF,GAAG,CAAC,CAAC;AAEL,SAAO,6BAAAC,QAAA,cAAC,IAAI,UAAJ,EAAa,OAAO,WAAU,QAAS;AACjD;AAEA,IAAM,uBAAuB,IAAI,YAC/B,6BAAAA,QAAA;AAAA,EAAC;AAAA;AAAA,IACC,yBAAyB;AAAA,MACvB,QAAQ,8FAA8F,KAAK;AAAA,QACzG;AAAA,MACF,EAAE,WAAW,MAAM,MAAM,CAAC;AAAA,IAC5B;AAAA;AACF;AAGF,IAAM,mBAAmB,CAAC,YAA4C;AACpE,MAAI,OAAO,WAAW;AAAa;AAEnC,UAAQ,QAAQ,CAAC,GAAG;AAAA,IAClB,KAAK,OAAO;AACV,uBAAAD,QAAU;AAAA,QACR,QAAQ,CAAC;AAAA,QACT,QAAQ,CAAC;AAAA,QACT,QAAQ,CAAC,KAAK,4BAA4B,QAAQ,CAAC,CAAC;AAAA,MACtD;AACA;AAAA,IACF;AAAA,IAEA,KAAK,UAAU;AACb,uBAAAA,QAAU;AAAA,QACR,QAAQ,CAAC;AAAA,QACT,QAAQ,CAAC,KAAK,4BAA4B,QAAQ,CAAC,CAAC;AAAA,MACtD;AACA;AAAA,IACF;AAAA,EACF;AACF;AAEA,IAAM,8BAA8B,CAClC,gBACsB;AAAA,EACtB,GAAG;AAAA,EACH,SACE,OAAO,WAAW,YAAY,WAC1B,IAAI,KAAK,WAAW,OAAO,IAC3B,WAAW;AACnB;","names":["jsCookies","React"]}